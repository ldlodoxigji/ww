# Руководство по запуску фонового парсера

## Что изменилось
- **Безопасная инициализация БД**: `sequelize.ensureDatabase()` выполняет `authenticate()` и один раз вызывает `sync({ alter: false })`, чтобы не трогать существующие данные и избегать случайного `force`/`alter` на каждом запуске.
- **Учёт задач**: таблица `TaskRun` сохраняет источник запуска, статус (`running/success/error`), время старта/завершения и текст ошибки.
- **Блокировка параллельного запуска**: таблица `JobLock` с уникальным ключом `source` не позволяет стартовать второй экземпляр парсера для того же источника, пока первый не завершится.
- **Привязка данных**: товары (`ParsedData`) теперь связаны с записью страницы (`Page`) по `pageId`.

## Подготовка окружения
1. Установить зависимости (при отсутствии доступа в интернет можно использовать уже лежащие в `code_amazon/node_modules`):
   ```bash
   npm install
   ```
   Если npm недоступен, убедитесь, что в `node_modules` есть симлинки на `cheerio` и `node-fetch` (они уже добавлены в репозиторий).
2. Создать/обновить БД автоматически не требуется — это делает `sequelize.ensureDatabase()` при первом запуске.

## Одноразовый запуск для проверки
```bash
node index.js
```
- После завершения соединение с БД закрывается.
- В таблице `TaskRun` появится запись со статусом выполнения и временем старта/окончания.

## Фоновый режим и расписание
Запуск приложения, которое сразу стартует задачу и затем повторяет её каждые 5 минут:
```bash
node schedule.js
```
- Планировщик использует `setInterval` внутри процесса, поэтому нет сторонних зависимостей.
- При новом запуске проверяется блокировка в `JobLock`, поэтому одновременный сбор из одного источника невозможен.

## Настройка PM2
1. **Старт по конфигу** (рекомендуется для защиты):
   ```bash
   pm2 start ecosystem.config.js
   ```
2. **Автозапуск при перезагрузке сервера**:
   ```bash
   pm2 startup
   pm2 save
   ```
3. **Просмотр логов и статуса**:
   ```bash
   pm2 logs scheduled-scraper
   pm2 status
   ```

### Альтернатива без ecosystem-файла
```bash
pm2 start schedule.js --name "scheduled-scraper" --time
```

## Где смотреть результаты
- **Товары**: таблица `ParsedData`, связана с `Page` по `pageId`.
- **История запусков**: таблица `TaskRun` (статус, время начала/окончания, ошибка, `pageId`).
- Быстрая проверка через sqlite-cli:
  ```bash
  sqlite3 database.sqlite "SELECT source, status, startedAt, finishedAt, errorMessage FROM TaskRun ORDER BY startedAt DESC LIMIT 5;"
  sqlite3 database.sqlite "SELECT COUNT(*) AS products, pageId FROM ParsedData GROUP BY pageId;"
  ```

## Как показать на защите
1. Запустить `pm2 start ecosystem.config.js` и убедиться, что процесс в списке `pm2 status`.
2. Посмотреть логи `pm2 logs scheduled-scraper` — там будут отметки о старте и завершении работы каждые 5 минут и сообщения о блокировке при попытке параллельного запуска.
3. Открыть `database.sqlite` и показать таблицы `TaskRun` и `ParsedData` с реальными данными.
4. Продемонстрировать, что повторный вызов `node schedule.js` не запускает второй сбор: в логах появится предупреждение «парсер уже работает», а новых строк со статусом `running` без завершения нет.
5. При желании завершить процесс: `pm2 stop scheduled-scraper` и `pm2 delete scheduled-scraper`.
